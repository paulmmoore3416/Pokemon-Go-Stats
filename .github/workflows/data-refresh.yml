name: Scheduled data refresh

on:
  schedule:
    # weekly refresh — adjust schedule as needed
    - cron: '0 6 * * 1'
  workflow_dispatch: {}

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Ensure data dir exists
        run: |
          mkdir -p data

      - name: Run refresh script
        env:
          GITHUB_ACTIONS: true
        run: |
          python3 scripts/refresh_pokeapi.py --limit 151 --out data/pokemon.json

      - name: Commit and open PR if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git status --porcelain | grep -q data/pokemon.json; then
            BRANCH="data-refresh-$(date +%Y%m%d%H%M%S)"
            git checkout -b ${BRANCH}
            git add data/pokemon.json
            git -c user.name='github-actions' -c user.email='actions@github.com' commit -m "chore(data): refresh canonical pokemon data"
            git push --set-upstream origin ${BRANCH}
            # create a PR (title + body)
            gh pr create --title "chore(data): refresh canonical PokeAPI dataset" --body "Automated data refresh from PokeAPI — please review and merge when ready." --base main
          else
            echo "No data changes detected"
          fi
